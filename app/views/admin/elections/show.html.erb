<% content_for :title, @election.name %>

<% content_for :primary do %>
<div class="container-fluid">

      <h2>Overview</h2>

      <% url = request.protocol + request.host_with_port + "/" + @election.slug %>

      <p>
        <b>Name:</b> <%= @election.name %><br>
        <b>URL:</b> <a href="<%= url %>" target="_blank"><%= url %></a>
      </p>

      <% if @election.archived? %>
        <div class="alert alert-warning" role="alert">
          <strong>This election has been archived.</strong>
        </div>
      <% end %>

      <%
      todos = []
      if !@election.config[:allow_local_voting] && !@election.config[:allow_remote_voting]
        todos << "You haven't chosen how people can access the ballot. Click \"Settings\" on the left side to choose it."
      end
      if !@election.projects.exists?
        todos << "You don't have any project. Click \"Projects\" on the left side to set up new projects."
      end
      %>

      <% if !todos.empty? %>
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">To-dos</h5>
          <div class="card-text">
            <ul style="margin-bottom: 0;">
              <% todos.each do |todo| %>
                <li><%= todo %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
      <% end %>

<!--

      <% if !todos.empty? %>
        <div><b>To-dos:</b></div>
        <ul>
          <% todos.each do |todo| %>
            <li><%= todo %></li>
          <% end %>
        </ul>
      <% end %>
-->

      <br>

      <% if current_user.admin?(@election) %>
        <% if @election.archived? %>
          <p><span class="text-muted">Register in-person voters (disabled - election archived)</span></p>
        <% else %>
          <p><a class="btn btn-outline-primary" href="<%= admin_election_voter_registration_records_path(@election) %>"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>&nbsp; Register in-person voters</a></p>
        <% end %>
      <% end %>

      <% if @election.config[:allow_local_voting] %>
        <% if @election.archived? %>
          <p><span class="text-muted">Convert this computer to a voting machine (disabled - election archived)</span></p>
        <% else %>
          <p><a class="btn btn-outline-primary" href="/admin/elections/<%= @election.id %>/to_voting_machine"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>&nbsp; Convert this computer to a voting machine</a></p>
        <% end %>
      <% end %>

      <br><br>

      <%#= h(@election.config_yaml).gsub("\n", '<br>').gsub('  ', '&nbsp;').html_safe %>

      <% if current_user.superadmin? %>
        <p>
          <% if @election.archived? %>
            <span class="text-muted">This election has been archived</span> |
          <% else %>
            <a href="#" data-toggle="modal" data-target="#confirm-archive" style="color: red;">Archive this Election</a> |
          <% end %>
          <a href="#" data-toggle="modal" data-target="#confirm-delete">Delete this election...</a>
        </p>
      <% end %>

      <div class="modal fade" id="confirm-archive" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <%= form_with url: archive_admin_election_path(@election), method: :post, local: true, id: "archive-form" do |form| %>
              <div class="modal-header">
                <h5 class="modal-title">Archive Election</h5>
              </div>
              <div class="modal-body">
                <div class="alert alert-info" role="alert">
                  <strong>Note:</strong> Archiving will lead to data loss:
                  <ul class="mb-0 mt-2">
                    <li>IP addresses will be hashed</li>
                    <li>Device Information will be hashed</li>
                    <li>Authentication IDs will be anonymized</li>
                    <li>Voter registration data will be cleared</li>
                  </ul>
                  <p class="mb-0 mt-2">These changes cannot be undone.</p>
                </div>
                
                <div class="alert alert-info" role="alert">
                  <strong>Before archiving, please verify:</strong>
                  <ul class="mb-0 mt-2">
                    <li>Has this election ended?</li>
                    <li>Have you checked if any test votes need to be voided? <a href="<%= admin_election_voters_path(@election) %>" target="_blank">Check the Voters tab</a></li>
                  </ul>
                </div>
                
                <div class="form-group">
                  <%= form.label :archive_info, "Additional Information:" %>
                  <%= form.text_area :archive_info, class: "form-control", rows: 3, placeholder: "Enter any additional information (optional)" %>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <%= form.submit "Archive", class: "btn btn-primary" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Are you sure?</h5>
            </div>
            <div class="modal-body">
              Are you sure you want to delete this election? This action cannot be undone.
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <a href="<%= admin_election_path(@election) %>" data-method="delete" class="btn btn-danger danger">Delete</a>
            </div>
          </div>
        </div>
      </div>


</div>
<% end %>

<%= render partial: 'shared/admin_template', locals: {items: [
  @election
]} %>
